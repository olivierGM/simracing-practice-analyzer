<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Final Timezone</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .result { background: #f0f0f0; padding: 10px; margin: 10px 0; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
        .warning { background: #fff3e0; color: #ef6c00; }
    </style>
</head>
<body>
    <h1>üîç Debug Final Timezone - Analyse Compl√®te</h1>
    
    <div class="debug-section">
        <h2>üìä Donn√©es de r√©f√©rence</h2>
        <div id="reference-data"></div>
    </div>
    
    <div class="debug-section">
        <h2>üß™ Test avec donn√©es r√©elles</h2>
        <div id="real-data-test"></div>
        <button onclick="testRealData()">üéØ Tester avec donn√©es r√©elles</button>
    </div>
    
    <div class="debug-section">
        <h2>üîß Simulation de parsing de fichier</h2>
        <div id="file-parsing-test"></div>
        <button onclick="testFileParsing()">üìÅ Tester parsing de fichier</button>
    </div>
    
    <div class="debug-section">
        <h2>‚è∞ Comparaison finale</h2>
        <div id="final-comparison"></div>
        <button onclick="finalComparison()">‚ö° Comparaison finale</button>
    </div>

    <script>
        // Donn√©es de r√©f√©rence
        function showReferenceData() {
            const now = new Date();
            const sessionServerUTC = new Date('2025-10-15T15:10:20Z'); // Wed, 15 Oct 2025 15:10:20 UTC
            const sessionEAST = new Date(sessionServerUTC.getTime() + (2.5 * 60 * 60 * 1000)); // +2h30
            
            document.getElementById('reference-data').innerHTML = `
                <div class="result">
                    <h3>üìä Donn√©es de r√©f√©rence :</h3>
                    <p><strong>Maintenant :</strong> ${now.toISOString()} (${now.toLocaleString('fr-FR')})</p>
                    <p><strong>Session serveur :</strong> ${sessionServerUTC.toISOString()} (15:10:20 UTC)</p>
                    <p><strong>Session EAST :</strong> ${sessionEAST.toISOString()} (17:40:20 EAST)</p>
                    <p><strong>Diff√©rence attendue :</strong> ${Math.floor((now.getTime() - sessionEAST.getTime()) / (1000 * 60 * 60))}h</p>
                    <p><strong>Attendu :</strong> "Il y a ~1h"</p>
                    <p><strong>Actuel :</strong> "Il y a 8h" ‚ùå</p>
                </div>
            `;
        }
        
        // Test avec donn√©es r√©elles
        function testRealData() {
            const now = new Date();
            const sessionServerUTC = new Date('2025-10-15T15:10:20Z');
            
            // Simulation de notre fonction formatUpdateDate
            const diffMs = now.getTime() - sessionServerUTC.getTime();
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMinutes = Math.floor(diffMs / (1000 * 60));
            
            let result;
            if (diffMinutes < 1) {
                result = '√Ä l\'instant';
            } else if (diffMinutes < 60) {
                result = `Il y a ${diffMinutes}min`;
            } else if (diffHours < 24) {
                result = `Il y a ${diffHours}h`;
            } else {
                result = `Il y a ${Math.floor(diffMs / (1000 * 60 * 60 * 24))}j`;
            }
            
            document.getElementById('real-data-test').innerHTML = `
                <div class="result ${diffHours > 5 ? 'error' : 'success'}">
                    <h3>üß™ Test avec donn√©es r√©elles :</h3>
                    <p><strong>Date session (UTC) :</strong> ${sessionServerUTC.toISOString()}</p>
                    <p><strong>Maintenant :</strong> ${now.toISOString()}</p>
                    <p><strong>Diff√©rence ms :</strong> ${diffMs}</p>
                    <p><strong>Diff√©rence heures :</strong> ${diffHours}h</p>
                    <p><strong>R√©sultat formatUpdateDate :</strong> "${result}"</p>
                    <p><strong>Probl√®me :</strong> ${diffHours > 5 ? '‚ùå ENCORE TROP √âLEV√â' : '‚úÖ OK'}</p>
                </div>
            `;
        }
        
        // Test de parsing de fichier
        function testFileParsing() {
            // Simuler un nom de fichier bas√© sur la date serveur
            // Wed, 15 Oct 2025 15:10:20 UTC ‚Üí fichier probablement nomm√© avec cette heure
            const fileName = "251015_151020_FP"; // Format suppos√©
            
            // Notre fonction de parsing
            const dateStr = fileName.substring(0, 6);
            const timeStr = fileName.substring(7, 13);
            
            const year = "20" + dateStr.substring(0, 2);
            const month = dateStr.substring(2, 4);
            const day = dateStr.substring(4, 6);
            const hour = timeStr.substring(0, 2);
            const minute = timeStr.substring(2, 4);
            const second = timeStr.substring(4, 6);
            
            // Parsing EAST ‚Üí UTC
            const hourNum = parseInt(hour);
            const minuteNum = parseInt(minute);
            const secondNum = parseInt(second);
            
            const utcHour = hourNum - 2;
            const utcMinute = minuteNum - 30;
            
            let finalHour = utcHour;
            let finalMinute = utcMinute;
            let dayOffset = 0;
            
            if (finalMinute < 0) {
                finalMinute += 60;
                finalHour -= 1;
            }
            if (finalHour < 0) {
                finalHour += 24;
                dayOffset = -1;
            }
            
            const parsedDate = new Date(Date.UTC(parseInt(year), parseInt(month) - 1, parseInt(day) + dayOffset, finalHour, finalMinute, secondNum));
            
            document.getElementById('file-parsing-test').innerHTML = `
                <div class="result">
                    <h3>üìÅ Test de parsing de fichier :</h3>
                    <p><strong>Fichier simul√© :</strong> ${fileName}</p>
                    <p><strong>Composants :</strong> ${year}-${month}-${day} ${hour}:${minute}:${second}</p>
                    <p><strong>Conversion EAST‚ÜíUTC :</strong> ${finalHour}:${finalMinute}:${second} UTC</p>
                    <p><strong>Date pars√©e :</strong> ${parsedDate.toISOString()}</p>
                    <p><strong>Date attendue :</strong> 2025-10-15T12:40:20.000Z (15:10 EAST ‚Üí 12:40 UTC)</p>
                    <p><strong>Correspondance :</strong> ${parsedDate.toISOString().includes('12:40') ? '‚úÖ CORRECT' : '‚ùå INCORRECT'}</p>
                </div>
            `;
        }
        
        // Comparaison finale
        function finalComparison() {
            const now = new Date();
            const sessionServerUTC = new Date('2025-10-15T15:10:20Z');
            
            // Test 1: Utiliser directement la date serveur UTC
            const diff1 = now.getTime() - sessionServerUTC.getTime();
            const hours1 = Math.floor(diff1 / (1000 * 60 * 60));
            
            // Test 2: Utiliser la date pars√©e du fichier (si elle √©tait nomm√©e avec l'heure EAST)
            const fileName = "251015_151020_FP";
            const dateStr = fileName.substring(0, 6);
            const timeStr = fileName.substring(7, 13);
            const year = "20" + dateStr.substring(0, 2);
            const month = dateStr.substring(2, 4);
            const day = dateStr.substring(4, 6);
            const hour = timeStr.substring(0, 2);
            const minute = timeStr.substring(2, 4);
            const second = timeStr.substring(4, 6);
            
            const hourNum = parseInt(hour);
            const minuteNum = parseInt(minute);
            const secondNum = parseInt(second);
            const utcHour = hourNum - 2;
            const utcMinute = minuteNum - 30;
            
            let finalHour = utcHour;
            let finalMinute = utcMinute;
            let dayOffset = 0;
            
            if (finalMinute < 0) {
                finalMinute += 60;
                finalHour -= 1;
            }
            if (finalHour < 0) {
                finalHour += 24;
                dayOffset = -1;
            }
            
            const parsedDate = new Date(Date.UTC(parseInt(year), parseInt(month) - 1, parseInt(day) + dayOffset, finalHour, finalMinute, secondNum));
            const diff2 = now.getTime() - parsedDate.getTime();
            const hours2 = Math.floor(diff2 / (1000 * 60 * 60));
            
            document.getElementById('final-comparison').innerHTML = `
                <div class="result">
                    <h3>‚ö° Comparaison finale :</h3>
                    <div class="result warning">
                        <h4>üéØ Solution probable :</h4>
                        <p><strong>Le probl√®me :</strong> Nous utilisons la date pars√©e du fichier au lieu de la date serveur UTC</p>
                        <p><strong>Date serveur UTC :</strong> ${sessionServerUTC.toISOString()} ‚Üí ${hours1}h de diff√©rence</p>
                        <p><strong>Date pars√©e fichier :</strong> ${parsedDate.toISOString()} ‚Üí ${hours2}h de diff√©rence</p>
                        <p><strong>Recommandation :</strong> Utiliser directement la date serveur UTC si disponible</p>
                    </div>
                </div>
            `;
        }
        
        // Auto-run au chargement
        window.addEventListener('load', () => {
            showReferenceData();
            testRealData();
            testFileParsing();
            setTimeout(finalComparison, 1000);
        });
    </script>
</body>
</html>
