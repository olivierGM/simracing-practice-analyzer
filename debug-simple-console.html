<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Simple Console</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .result { background: #f0f0f0; padding: 10px; margin: 10px 0; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
        .warning { background: #fff3e0; color: #ef6c00; }
        .console-output { background: #000; color: #0f0; padding: 10px; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>üîç Debug Simple Console - Probl√®me Timezone</h1>
    
    <div class="debug-section">
        <h2>üìä Test de parsing de fichier</h2>
        <div id="parsing-test"></div>
        <button onclick="testParsing()">üß™ Tester le parsing</button>
    </div>
    
    <div class="debug-section">
        <h2>‚è∞ Test de formatUpdateDate</h2>
        <div id="format-test"></div>
        <button onclick="testFormat()">üéØ Tester formatUpdateDate</button>
    </div>
    
    <div class="debug-section">
        <h2>üì± Simulation compl√®te</h2>
        <div id="simulation-test"></div>
        <button onclick="runSimulation()">üöÄ Lancer simulation compl√®te</button>
    </div>
    
    <div class="debug-section">
        <h2>üìù Console Output</h2>
        <div id="console-output" class="console-output"></div>
        <button onclick="clearConsole()">üóëÔ∏è Effacer</button>
    </div>

    <script>
        // Capturer les logs de console
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        
        let consoleOutput = '';
        
        function logToOutput(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            consoleOutput += `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            document.getElementById('console-output').textContent = consoleOutput;
        }
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            logToOutput(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            logToOutput(args.join(' '), 'error');
        };
        
        console.warn = function(...args) {
            originalConsoleWarn.apply(console, args);
            logToOutput(args.join(' '), 'warn');
        };
        
        function clearConsole() {
            consoleOutput = '';
            document.getElementById('console-output').textContent = '';
        }
        
        // Fonction de parsing (copi√©e du code actuel)
        function parseSessionDate(fileName) {
            console.log('üîç Parsing fichier:', fileName);
            
            const dateStr = fileName.substring(0, 6);
            const timeStr = fileName.substring(7, 13);
            
            if (dateStr && timeStr) {
                const year = "20" + dateStr.substring(0, 2);
                const month = dateStr.substring(2, 4);
                const day = dateStr.substring(4, 6);
                const hour = timeStr.substring(0, 2);
                const minute = timeStr.substring(2, 4);
                const second = timeStr.substring(4, 6);
                
                console.log('üìÖ Composants:', { year, month, day, hour, minute, second });
                
                const hourNum = parseInt(hour);
                const minuteNum = parseInt(minute);
                const secondNum = parseInt(second);
                
                // Utiliser directement en UTC (pas de conversion)
                const date = new Date(Date.UTC(parseInt(year), parseInt(month) - 1, parseInt(day), hourNum, minuteNum, secondNum));
                
                console.log('üìÖ Date pars√©e (UTC):', date.toISOString());
                return date;
            }
            return null;
        }
        
        // Fonction formatUpdateDate (copi√©e du code actuel)
        function formatUpdateDate(date) {
            console.log('üïê Debug formatUpdateDate:');
            console.log('  Date session (UTC):', date.toISOString());
            
            const now = new Date();
            console.log('  Maintenant (locale):', now.toISOString());
            
            const diffMs = now.getTime() - date.getTime();
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMinutes = Math.floor(diffMs / (1000 * 60));
            
            console.log('  Diff√©rence ms:', diffMs);
            console.log('  Diff√©rence heures:', diffHours);
            
            let result;
            if (diffMinutes < 1) {
                result = '√Ä l\'instant';
            } else if (diffMinutes < 60) {
                result = `Il y a ${diffMinutes}min`;
            } else if (diffHours < 24) {
                result = `Il y a ${diffHours}h`;
            } else if (diffDays === 1) {
                result = 'Hier';
            } else if (diffDays < 7) {
                result = `Il y a ${diffDays}j`;
            } else {
                result = date.toLocaleDateString('fr-FR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: '2-digit'
                });
            }
            
            console.log('üìä R√©sultat final:', result);
            return result;
        }
        
        function testParsing() {
            console.log('üß™ Test de parsing de fichier');
            
            // Test avec le fichier de la session serveur
            const fileName = "251015_151020_FP"; // 15:10:20 UTC
            const parsedDate = parseSessionDate(fileName);
            const expectedDate = new Date('2025-10-15T15:10:20Z');
            
            const isCorrect = parsedDate && Math.abs(parsedDate.getTime() - expectedDate.getTime()) < 1000;
            
            document.getElementById('parsing-test').innerHTML = `
                <div class="result ${isCorrect ? 'success' : 'error'}">
                    <h3>üìÅ Test de parsing:</h3>
                    <p><strong>Fichier:</strong> ${fileName}</p>
                    <p><strong>Date pars√©e:</strong> ${parsedDate ? parsedDate.toISOString() : 'null'}</p>
                    <p><strong>Date attendue:</strong> ${expectedDate.toISOString()}</p>
                    <p><strong>Statut:</strong> ${isCorrect ? '‚úÖ CORRECT' : '‚ùå INCORRECT'}</p>
                </div>
            `;
        }
        
        function testFormat() {
            console.log('üéØ Test de formatUpdateDate');
            
            // Test avec une date r√©cente (il y a 2h)
            const sessionDate = new Date(Date.now() - (2 * 60 * 60 * 1000));
            const result = formatUpdateDate(sessionDate);
            
            const isCorrect = result.includes('2h');
            
            document.getElementById('format-test').innerHTML = `
                <div class="result ${isCorrect ? 'success' : 'error'}">
                    <h3>‚è∞ Test formatUpdateDate:</h3>
                    <p><strong>Date session:</strong> ${sessionDate.toISOString()}</p>
                    <p><strong>R√©sultat:</strong> "${result}"</p>
                    <p><strong>Attendu:</strong> "Il y a 2h"</p>
                    <p><strong>Statut:</strong> ${isCorrect ? '‚úÖ CORRECT' : '‚ùå INCORRECT'}</p>
                </div>
            `;
        }
        
        function runSimulation() {
            console.log('üöÄ Simulation compl√®te');
            
            // Simuler le workflow complet
            const fileName = "251015_151020_FP";
            const parsedDate = parseSessionDate(fileName);
            
            if (parsedDate) {
                // Simuler la dur√©e de session (90min)
                const sessionDurationMinutes = 90;
                const sessionEndDate = new Date(parsedDate.getTime() + (sessionDurationMinutes * 60 * 1000));
                
                // Utiliser la fin de session si elle est plus r√©cente que maintenant
                const now = new Date();
                const actualLastUpdate = sessionEndDate > now ? parsedDate : sessionEndDate;
                
                console.log('üìä Session duration:', sessionDurationMinutes + 'min');
                console.log('üìä Session end:', sessionEndDate.toISOString());
                console.log('üìä Actual last update:', actualLastUpdate.toISOString());
                
                const result = formatUpdateDate(actualLastUpdate);
                
                document.getElementById('simulation-test').innerHTML = `
                    <div class="result">
                        <h3>üöÄ Simulation compl√®te:</h3>
                        <p><strong>Fichier:</strong> ${fileName}</p>
                        <p><strong>D√©but session:</strong> ${parsedDate.toISOString()}</p>
                        <p><strong>Fin session:</strong> ${sessionEndDate.toISOString()}</p>
                        <p><strong>Date utilis√©e:</strong> ${actualLastUpdate.toISOString()}</p>
                        <p><strong>R√©sultat final:</strong> "${result}"</p>
                        <p><strong>Attendu:</strong> "Il y a ~2h"</p>
                        <p><strong>Statut:</strong> ${result.includes('h') && !result.includes('8h') && !result.includes('10h') ? '‚úÖ PROBABLEMENT CORRECT' : '‚ùå ENCORE UN PROBL√àME'}</p>
                    </div>
                `;
            }
        }
        
        // Auto-run au chargement
        window.addEventListener('load', () => {
            console.log('üöÄ Page de debug charg√©e');
            testParsing();
            setTimeout(() => {
                testFormat();
                setTimeout(runSimulation, 1000);
            }, 1000);
        });
    </script>
</body>
</html>
